---
title: "Untitled"
author: "Anishkumar Senthil"
date: "2025-11-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

```{r pressure, echo=FALSE}
plot(pressure)
```
 
## Select top predictive proteins 


```{r select-top, message=FALSE, warning=FALSE}
top_n <- 20

load('../data/biomarker-clean.RData') 

library(dplyr)

dat <- biomarker_clean
dat$group <- factor(dat$group)

proteins <- setdiff(names(dat), c('group','ados'))

tt_res <- sapply(proteins, function(p){
	x <- dat[[p]]
	grp <- dat$group
	ok <- !is.na(x) & !is.na(grp)
	if(sum(ok) < 3) return(NA)
	t <- try(t.test(x[ok] ~ grp[ok]), silent=TRUE)
	if(inherits(t,'try-error')) return(NA)
	t$p.value
})
tt_df <- tibble::tibble(protein = proteins,
											 pvalue = as.numeric(tt_res)) %>%
	arrange(pvalue) %>%
	slice_head(n = top_n)

if(!requireNamespace('randomForest', quietly = TRUE)) {
	stop("Package 'randomForest' required. Please install it before running this chunk.")
}
rf_dat <- dat %>% dplyr::select(dplyr::all_of(proteins))
rf_resp <- dat$group
rf_fit <- randomForest::randomForest(x = rf_dat, y = rf_resp, ntree = 1000, importance = TRUE)
rf_imp_mat <- randomForest::importance(rf_fit, type = 2)
rf_imp_val <- if(is.matrix(rf_imp_mat)) rf_imp_mat[,1] else rf_imp_mat
rf_df <- tibble::tibble(protein = names(rf_imp_val), importance = as.numeric(rf_imp_val)) %>%
	arrange(desc(importance)) %>%
	slice_head(n = top_n)

if(!requireNamespace('glmnet', quietly = TRUE)) {
	stop("Package 'glmnet' required. Please install it before running this chunk.")
}
X <- as.matrix(rf_dat)
y <- as.numeric(dat$group) - 1
cv <- glmnet::cv.glmnet(X, y, family = 'binomial', alpha = 1, nfolds = 5)
# Get coefficients using the generic coef() function
coef_min <- as.matrix(coef(cv, s = 'lambda.min'))
# Remove intercept (first row) and get coefficients
coefs <- coef_min[-1,1]
lasso_df <- tibble::tibble(protein = proteins, coef = as.numeric(coefs)) %>%
	mutate(abscoef = abs(coef)) %>%
	arrange(desc(abscoef)) %>%
	slice_head(n = top_n)

tt_top <- tt_df$protein
rf_top <- rf_df$protein
lasso_top <- lasso_df$protein

cat(glue::glue("Selected top {top_n} proteins by each method:\n"))
cat("- t-test (by p-value):\n")
print(tt_top)
cat('\n- Random Forest (importance):\n')
print(rf_top)
cat('\n- LASSO (coef magnitude):\n')
print(lasso_top)

unique_proteins <- unique(c(tt_top, rf_top, lasso_top))
cat('\nTotal unique proteins across methods: ', length(unique_proteins), '\n')

selected_lists <- list(tt = tt_df, rf = rf_df, lasso = lasso_df)

selected_lists
```